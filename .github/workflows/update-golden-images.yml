name: Update Golden Images

on:
  workflow_dispatch:
    inputs:
      browsers:
        description: 'Browsers (comma-separated: chromium,firefox,webkit)'
        required: true
        default: 'chromium,firefox,webkit'
      devices:
        description: 'Devices (comma-separated: desktop,mobile)'
        required: true
        default: 'desktop,mobile'
      pages:
        description: 'Pages (comma-separated or "all")'
        required: false
        default: 'all'

jobs:
  update-golden:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        device: [desktop, mobile]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: '3.11'

      - name: Cache Pipenv dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.local/share/virtualenvs
          key: ${{ runner.os }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pipenv-

      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --dev
          npm install
          pipenv run playwright install --with-deps

      - name: Start app for screenshots
        run: |
          export DEVELOPMENT_MODE=1
          pipenv run invoke update-docs
          pipenv run invoke site
          pipenv run invoke post-process
          nohup pipenv run invoke serve &
          sleep 5

      - name: Generate golden images
        run: |
          ARGS="--update-golden --browsers ${{ matrix.browser }} --devices ${{ matrix.device }} --wait 1000 --clean --verbose"
          if [ "${{ github.event.inputs.pages }}" != "all" ]; then
            ARGS="$ARGS --pages ${{ github.event.inputs.pages }}"
          fi
          pipenv run python update.py $ARGS
          echo "Golden images generated for ${{ matrix.browser }}/${{ matrix.device }}"
          ls -lah tests/golden/

      - name: Save golden images to cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: tests/golden/
          key: golden-images-${{ matrix.browser }}-${{ matrix.device }}-${{ hashFiles('src/**', 'update.py') }}

      - name: Upload golden images as backup artifact
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: golden-backup-${{ matrix.browser }}-${{ matrix.device }}-${{ github.run_number }}
          path: tests/golden/
          retention-days: 90

  summary:
    needs: update-golden
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Create update summary
        run: |
          echo "# Golden Images Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browsers:** ${{ github.event.inputs.browsers }}" >> $GITHUB_STEP_SUMMARY
          echo "**Devices:** ${{ github.event.inputs.devices }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pages:** ${{ github.event.inputs.pages }}" >> $GITHUB_STEP_SUMMARY
          echo "New golden images have been generated, cached, and backup artifacts uploaded (90-day retention)." >> $GITHUB_STEP_SUMMARY
          echo "Next visual regression test run will use these images as baseline."
